<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Care Plan Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[1600px] mx-auto">
        
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border-b-4 border-blue-500">
            <div>
                <h1 class="text-2xl font-black text-slate-800 uppercase italic tracking-tighter">Nutrition Care Plan</h1>
                <p id="status" class="text-slate-400 text-xs font-bold mt-1 uppercase italic tracking-widest">â— Clinical Analytics Dashboard</p>
            </div>
            <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition">ğŸ”„ Refresh Data</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <h3 class="font-black text-slate-700 uppercase mb-6 flex items-center gap-2">
                    ğŸ§ª Lab Results Analysis (Albumin vs Protein)
                </h3>
                <div class="chart-container"><canvas id="labChart"></canvas></div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <h3 class="font-black text-slate-700 uppercase mb-6 flex items-center gap-2">
                    ğŸ¥ Patient Distribution by Ward
                </h3>
                <div class="chart-container"><canvas id="wardChart"></canvas></div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <h3 class="font-black text-slate-700 uppercase mb-6 flex items-center gap-2 text-blue-600">
                    ğŸ† Top 5 Diagnosis (Major Diseases)
                </h3>
                <div class="chart-container"><canvas id="diagChart"></canvas></div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <h3 class="font-black text-slate-700 uppercase mb-6 flex items-center gap-2 text-orange-500">
                    ğŸ¦  Top 5 Underlying Diseases
                </h3>
                <div class="chart-container"><canvas id="underChart"></canvas></div>
            </div>

        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
             <div class="bg-emerald-500 p-8 rounded-[2.5rem] shadow-xl text-white">
                <h3 class="font-black uppercase mb-6 border-b border-white/20 pb-4">BMI Summary</h3>
                <div class="h-[250px]"><canvas id="bmiChart"></canvas></div>
            </div>
             <div class="bg-slate-800 p-8 rounded-[2.5rem] shadow-xl text-white">
                <h3 class="font-black uppercase mb-6 border-b border-white/20 pb-4">NAF Risk Analysis</h3>
                <div class="h-[250px]"><canvas id="nafChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbysuexIp4jKK95gvIx3gSiBmpKLKT91iH_xWjAc_RUo5R7qzN3MLOvk0ijkT9y8MlM/exec';

        async function initDashboard() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const result = await response.json();
                if (result.status !== 'success') return;
                const data = result.data;

                const getFreq = (key) => {
                    const counts = {};
                    data.forEach(d => { if(d[key]) counts[d[key]] = (counts[d[key]] || 0) + 1; });
                    return counts;
                };

                // 1. Lab Chart (Albumin & Protein Distribution)
                // à¹€à¸£à¸²à¸ˆà¸°à¹ƒà¸Šà¹‰à¸à¸£à¸²à¸Ÿà¹€à¸ªà¹‰à¸™à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸«à¸£à¸·à¸­à¸à¸£à¸²à¸Ÿà¹à¸—à¹ˆà¸‡à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢
                new Chart(document.getElementById('labChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Albumin', 'Total Protein'],
                        datasets: [{
                            label: 'Average Value (g/dL)',
                            data: [
                                (data.map(d => parseFloat(d.ALBUMIN)).filter(v => !isNaN(v)).reduce((a,b)=>a+b,0) / data.length).toFixed(2),
                                (data.map(d => parseFloat(d.TOTAL_PROTEIN)).filter(v => !isNaN(v)).reduce((a,b)=>a+b,0) / data.length).toFixed(2)
                            ],
                            backgroundColor: ['#10b981', '#3b82f6'],
                            borderRadius: 15
                        }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // 2. Ward Chart
                const wardMap = getFreq('WARD');
                new Chart(document.getElementById('wardChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(wardMap),
                        datasets: [{ data: Object.values(wardMap), backgroundColor: '#6366f1', borderRadius: 10 }]
                    },
                    options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // 3. Diagnosis Chart (Top 5)
                const diagMap = Object.entries(getFreq('DIAGNOSIS')).sort((a,b)=>b[1]-a[1]).slice(0,5);
                new Chart(document.getElementById('diagChart'), {
                    type: 'bar',
                    data: {
                        labels: diagMap.map(x => x[0]),
                        datasets: [{ label: 'à¸ˆà¸³à¸™à¸§à¸™à¹€à¸„à¸ª', data: diagMap.map(x => x[1]), backgroundColor: '#3b82f6', borderRadius: 8 }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // 4. Underlying Chart (Top 5)
                const underMap = Object.entries(getFreq('UNDERLYING')).sort((a,b)=>b[1]-a[1]).slice(0,5);
                new Chart(document.getElementById('underChart'), {
                    type: 'bar',
                    data: {
                        labels: underMap.map(x => x[0]),
                        datasets: [{ label: 'à¸ˆà¸³à¸™à¸§à¸™à¹€à¸„à¸ª', data: underMap.map(x => x[1]), backgroundColor: '#f97316', borderRadius: 8 }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // 5. BMI Pie
                const bmiMap = { 'Under':0, 'Normal':0, 'Over':0, 'Obese':0 };
                data.forEach(d => {
                    const b = parseFloat(d.BMI);
                    if(b < 18.5) bmiMap['Under']++; else if(b < 23) bmiMap['Normal']++; else if(b < 25) bmiMap['Over']++; else bmiMap['Obese']++;
                });
                new Chart(document.getElementById('bmiChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(bmiMap),
                        datasets: [{ data: Object.values(bmiMap), backgroundColor: ['#fbbf24', '#ffffff', '#3b82f6', '#f43f5e'] }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } } }
                });

                // 6. NAF Doughnut
                const nafMap = { 'Low': 0, 'Mid': 0, 'High': 0 };
                data.forEach(d => {
                    const s = parseInt(d.NAF_SCORE);
                    if(s <= 5) nafMap['Low']++; else if(s <= 10) nafMap['Mid']++; else nafMap['High']++;
                });
                new Chart(document.getElementById('nafChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(nafMap),
                        datasets: [{ data: Object.values(nafMap), backgroundColor: ['#10b981', '#f1c40f', '#ef4444'], borderWidth: 0 }]
                    },
                    options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { labels: { color: 'white' } } } }
                });

            } catch (e) { console.error(e); }
        }
        window.onload = initDashboard;
    </script>
</body>
</html>
